var e,t;!function(e){e[e.InitConnection=1]="InitConnection",e[e.Authenticate=15]="Authenticate",e[e.Acknowledge=6]="Acknowledge",e[e.Reconnect=22]="Reconnect",e[e.Topic=26]="Topic",e[e.Identifier=11]="Identifier",e[e.Error=21]="Error",e[e.Alert=7]="Alert",e[e.AddAction=12]="AddAction",e[e.DeleteAction=16]="DeleteAction",e[e.Server=24]="Server",e[e.Payload=29]="Payload",e[e.Presence=14]="Presence"}(e||(e={})),function(e){e[e.ArraySeparator=31]="ArraySeparator"}(t||(t={}));const s=e=>{const t=new ArrayBuffer(e.length),s=new Uint8Array(t),n=e.length+1;for(let t=0;t<n;t++)s[t]=e.charCodeAt(t);return t},n=e=>s(e),i=e=>a(e),a=e=>new Uint8Array(e).reduce(((e,t)=>e+String.fromCharCode(t)),"");class r{commandArray=[];setCommand(e,t){if(!e)return this;this.commandArray.push(e);let s=[];return t?(Array.isArray(t)?s=this.convertArray(t):"string"==typeof t&&(s=this.convertStringNumberArray(t)),this.commandArray=[...this.commandArray,...s],this):this}convertStringNumberArray(e){const t=n(e);return Array.from(new Uint8Array(t))}convertArray(e){return e.map((e=>this.convertStringNumberArray(e))).map((e=>(e.push(t.ArraySeparator),e))).flat()}build(){return new Uint8Array(this.commandArray)}}const o=()=>new r;class c{static parseData(e){return e instanceof ArrayBuffer?e:"string"==typeof e||e instanceof String?n(e):null!==(t=e)&&"object"==typeof t&&Object.getPrototypeOf(t)===Object.prototype?n(JSON.stringify(e)):void 0;var t}static encode(t,s){const n=this.parseData(s),i=new Uint8Array(1);i[0]=e.Payload;const a=t.build(),r=a.byteLength;let o,c=0,h=new Uint8Array(0);n&&(c=n.byteLength+1,h=new Uint8Array(n),o=r+1);const u=new ArrayBuffer(r+c),d=new Uint8Array(u);return d.set(a,0),n&&(d.set(i,r),d.set(h,o)),d.buffer}static decode(t){const s=t.byteLength,n=new Uint8Array(t);let i=n.indexOf(e.Payload);i=i<0?s:i;const a=n.slice(0,i),r=i+1,o=this.extractCommands(a);return{commands:o,payload:t.slice(r,s),getCommand:e=>!!o[e]&&o[e]}}static hasSeparatorIndexes(e){return e.indexOf(t.ArraySeparator)>0}static commandActionUint8ArrayToString(e){return e.map((e=>String.fromCharCode(e))).join("")}static commandActionUint8ArrayToStringArray(e){const s=[];let n=[];return e.forEach((e=>{e===t.ArraySeparator?(s.push(n),n=[]):n.push(e)})),n.length>0&&s.push(n),s.map((e=>this.commandActionUint8ArrayToString(e.map((e=>Number(e))))))}static extractCommands(t){const s={};let n=null;return t.forEach((t=>{if(Object.values(e).indexOf(t)>=0)return n=t,void(s[n]=[]);s[n].push(t)})),Object.keys(s).forEach((e=>{const t=s[e];this.hasSeparatorIndexes(t)?s[e]=this.commandActionUint8ArrayToStringArray(t):0===t.length?s[e]=!0:s[e]=this.commandActionUint8ArrayToString(t)})),s}}class h{topicName;initiate;authentication;identifiers;presence;constructor(e){this.topicName=e.topicName,this.initiate=e.initiate,this.authentication=e.authentication,this.identifiers=e.identifiers,this.presence=e.presence}identifiersToOrderedString(e){if(e&&e?.length)return e.sort().join("_")}generateKey(){return[this.initiate,this.authentication,this.topicName,this.identifiersToOrderedString(this.identifiers),this.presence].filter((e=>e)).join("_")}}var u,d,l,p,f,m,g,b;!function(e){e.Idle="idle",e.Initiate="initiate",e.Authentication="authentication",e.Connecting="connecting",e.Connected="connected",e.Disconnected="disconnected"}(u||(u={})),function(e){e.Arraybuffer="arraybuffer"}(d||(d={})),function(e){e.Hidden="hidden",e.Visible="visible"}(l||(l={})),function(e){e.Subscribe="subscribe",e.Publish="publish",e.PubSub="pubSub"}(p||(p={})),function(e){e.Active="active",e.Inactive="inactive"}(f||(f={})),function(e){e.Standard="standard",e.Api="api"}(m||(m={})),function(e){e.RoundRobbin="roundRobin"}(g||(g={})),function(e){e.AcknowledgeConnected="acknowledgeConnected",e.AcknowledgeAuthenticated="acknowledgeAuthenticated",e.AcknowledgeGeneral="acknowledgeGeneral",e.AcknowledgeError="acknowledgeError",e.OnReceive="onReceive",e.OnError="onError",e.OnClose="onClose",e.OnOpen="onOpen",e.TunnelAuthenticate="tunnelAuthenticate",e.TunnelHeartbeat="tunnelHeartbeat",e.TunnelPublish="tunnelPublish",e.TopicSubscribe="topicSubscribe",e.TopicUnsubscribe="topicUnsubscribe",e.TopicPublish="topicPublish",e.TopicAddIdentifier="topicAddIdentifier",e.TopicRemoveIdentifier="topicRemoveIdentifier",e.TopicPresence="topicPresence"}(b||(b={}));class v{connection;topicName;onReceiveCallback;identifiers=[];presence;acknowledgeQueueManager;_tunnel;constructor(e,t,s,n,i){this._tunnel=e,this.acknowledgeQueueManager=i,this.setConnection(t),this.topicName=s,this.saveIdentifiers(n?.OR??[])}saveIdentifiers(e){Array.isArray(e)&&e.map((e=>{this.identifiers.find((t=>t===e))||this.identifiers.push(e)}))}deleteSavedIdentifiers(e){const t=[];e.map((e=>{this.identifiers.find((t=>t===e))&&t.push(e)})),this.identifiers=t}async _subscribeAction(e,t,s){const n=c.encode(t);this.send(e,n),await this.acknowledgeQueueManager.addToSentQueue(new h({presence:this.presence?this.presence:void 0,topicName:this.topicName,identifiers:this.identifiers}),s)}tunnel(){return this._tunnel}subscribe(t){if(!this.topicName){const e=new Error("Topic name is required");if(!t)throw e;t(e,null)}const s=o().setCommand(e.Topic,this.topicName);return this.identifiers?.length&&this.identifiers.length>0&&s.setCommand(e.Identifier,this.identifiers),s.setCommand(e.AddAction),this._subscribeAction(b.TopicSubscribe,s,t),this}setPresence(t,s){this.presence=t;const n=o().setCommand(e.Topic,this.topicName);return this.identifiers.length>0&&n.setCommand(e.Identifier,this.identifiers),this.presence&&n.setCommand(e.Presence,this.presence),n.setCommand(e.AddAction),this._subscribeAction(b.TopicPresence,n,s),this}setConnection(e){return this.connection=e,this}_onReceiveMessage(e){return this.onReceiveCallback&&this.onReceiveCallback(e),this}onReceive(e){return this.onReceiveCallback=e,this}addIdentifiers(t,s){if(!t?.OR?.length||0===t?.OR?.length){const e=new Error("Identifiers are required.");if(!s)throw e;s(e,null)}const n=t?.OR??[];this.saveIdentifiers(n);const i=o().setCommand(e.Topic,this.topicName);n.length>0&&i.setCommand(e.Identifier,n),i.setCommand(e.AddAction);const a=c.encode(i);return this.send(b.TopicAddIdentifier,a),this.acknowledgeQueueManager.addToSentQueue(new h({topicName:this.topicName,identifiers:this.identifiers}),s),this}removeIdentifiers(t,s){if(!t?.length||0===t?.length){const e=new Error("Identifiers are required.");if(!s)throw e;s(e,null)}this.deleteSavedIdentifiers(t??[]);const n=o().setCommand(e.Topic,this.topicName);n.setCommand(e.Identifier,t),n.setCommand(e.DeleteAction);const i=c.encode(n);return this.send(b.TopicRemoveIdentifier,i),this.acknowledgeQueueManager.addToSentQueue(new h({topicName:this.topicName,identifiers:this.identifiers}),s),this}unsubscribe(t){const s=o().setCommand(e.Topic,this.topicName).setCommand(e.DeleteAction),n=c.encode(s);return this.send(b.TopicUnsubscribe,n),this.acknowledgeQueueManager.addToSentQueue(new h({topicName:this.topicName,identifiers:this.identifiers}),t),!0}publish(t,s){const n=o().setCommand(e.Topic,this.topicName);s&&s?.length>0&&n.setCommand(e.Identifier,s);const i=c.encode(n,t);return this.send(b.TopicPublish,i),this}send(e,t){this.connection&&this.connection.send(e,t)}}const I=e=>{if(!e)return"";const t=[],s=e;Object.keys(s).map((e=>{t.push(`${e}=${s[e]}`)}));const n=t.join("&");return n?`?${n}`:""},y={DefaultWsHost:"tunnel.nolag.app",DefaultApiHost:"api.nolag.app",DefaultWsUrl:"/ws",DefaultPort:443,DefaultWsProtocol:"wss",DefaultApiUrl:"/v1",DefaultHttpProtocol:"https"};class w{host;authToken;wsInstance;protocol;url;deviceConnectionId=void 0;deviceTokenId=null;defaultCheckConnectionInterval=100;defaultCheckConnectionTimeout=1e4;checkConnectionInterval;checkConnectionTimeout;reConnect=!1;debug=!1;callbackOnOpen=()=>{};callbackOnReceive=()=>{};callbackOnClose=()=>{};callbackOnError=()=>{};connectionStatus=u.Idle;buffer=[];backpressureSendInterval=0;senderInterval=0;unifiedWebsocket;acknowledgeQueueManager;bufferOnDisconnect=!1;constructor(e,t,s,n){this.acknowledgeQueueManager=s,this.authToken=t??"",this.host=n?.host??y.DefaultWsHost,this.protocol=n?.protocol??y.DefaultWsProtocol,this.url=y.DefaultWsUrl,this.checkConnectionInterval=n?.checkConnectionInterval??this.defaultCheckConnectionInterval,this.checkConnectionTimeout=n?.checkConnectionTimeout??this.defaultCheckConnectionTimeout,this.bufferOnDisconnect=n?.bufferOnDisconnect??this.bufferOnDisconnect,this.debug=n?.debug??this.debug,this.unifiedWebsocket=e,this.startSender()}startSender(){this.senderInterval=setInterval((()=>{if((this.bufferOnDisconnect||this.connectionStatus!==u.Disconnected)&&0!==this.buffer.length&&this.wsInstance&&this.connectionStatus===u.Connected){const e=this.buffer.shift();if(!e)return;this.wsInstance.send&&this.wsInstance.send(e)}}),this.backpressureSendInterval)}slowDownSender(e){clearInterval(this.senderInterval),this.backpressureSendInterval=e,this.startSender()}addToBuffer(e){this.buffer.push(e)}setReConnect(e){e&&(this.reConnect=e)}async connect(e){this.connectionStatus=u.Idle,await this.initWebsocketConnection(),await this.authenticate(e)}disconnect(){this.wsInstance&&this.wsInstance.close&&(this.wsInstance.close(),this.wsInstance=void 0)}async initWebsocketConnection(){return this.connectionStatus===u.Connected||(this.wsInstance=this.unifiedWebsocket(`${this.protocol}://${this.host}${this.url}`),!this.wsInstance||(this.wsInstance.onOpen=e=>{this._onOpen(e)},this.wsInstance.onMessage=e=>{this._onReceive(e)},this.wsInstance.onClose=e=>{this._onClose(e)},this.wsInstance.onError=e=>{this._onError(e)},await this.acknowledgeQueueManager.addToSentQueue(new h({initiate:u.Initiate})),!0))}async authenticate(t){this.connectionStatus=u.Connecting;const{authToken:s}=this,n=o().setCommand(e.Authenticate,s);this.reConnect&&n.setCommand(e.Reconnect),this.send(b.TunnelAuthenticate,c.encode(n)),await this.acknowledgeQueueManager.addToSentQueue(new h({authentication:u.Authentication}),t)}onOpen(e){this.callbackOnOpen=e}onReceiveMessage(e){this.callbackOnReceive=e}onClose(e){this.callbackOnClose=e}onError(e){this.callbackOnError=e}ackCommand(t){if(t.getCommand(e.InitConnection)&&this.connectionStatus===u.Idle)return this.acknowledgeQueueManager.addToReceivedQueue(new h({initiate:u.Initiate}),null,{}),this.debug&&console.log(`${b.AcknowledgeConnected}:`,t),!0;if(t.getCommand(e.Acknowledge)&&this.connectionStatus===u.Connecting){this.connectionStatus=u.Connected,this.deviceTokenId=t.getCommand(e.Acknowledge);let s=null;return t.getCommand(e.Error)&&(s=new Error(t.getCommand(e.Error))),this.acknowledgeQueueManager.addToReceivedQueue(new h({authentication:u.Authentication}),s,{}),this.debug&&console.log(`${b.AcknowledgeAuthenticated}:`,t),!0}if(t.getCommand(e.Acknowledge)){const s=new h({topicName:t.getCommand(e.Topic),identifiers:t.getCommand(e.Identifier),presence:t.getCommand(e.Presence)});return this.acknowledgeQueueManager.addToReceivedQueue(s,null,{}),this.debug&&(console.log(`${b.AcknowledgeGeneral}:`,s),console.log(`${b.AcknowledgeGeneral} generated KEY:`,s.generateKey())),!0}if(t.getCommand(e.Error)){const s=new h({topicName:t.getCommand(e.Topic),identifiers:t.getCommand(e.Identifier),presence:t.getCommand(e.Presence)});return this.acknowledgeQueueManager.addToReceivedQueue(s,null,{}),this.debug&&console.log(`${b.AcknowledgeError}:`,s),!0}return!1}_onOpen(e){this.connectionStatus=u.Idle,this.callbackOnOpen(void 0,e),this.debug&&console.log(`${b.OnOpen}:`,e)}_onReceive(t){const s=t??new ArrayBuffer(0),n=c.decode(s);if(0===s.byteLength)return;if(this.ackCommand(n))return;const i=n.getCommand(e.Identifier),a=n.getCommand(e.Presence),r={topicName:n.getCommand(e.Topic),presences:!0===a?[]:a,identifiers:!0===i?[]:i,data:n.payload};this.callbackOnReceive(void 0,r),this.debug&&console.log(`${b.OnReceive}:`,r)}_onClose(e){this.connectionStatus=u.Disconnected,this.callbackOnClose(e,void 0),this.debug&&console.log(`${b.OnClose}:`,e)}_onError(e){this.connectionStatus=u.Disconnected,this.callbackOnError(e,void 0),this.debug&&console.log(`${b.OnError}:`,e)}send(e,t){e===b.TunnelAuthenticate&&this.wsInstance?this.wsInstance?.send&&this.wsInstance.send(t):this.addToBuffer(t),this.debug&&console.log(`${e}:`,c.decode(t))}heartbeat(){this.wsInstance&&this.send(b.TunnelHeartbeat,new ArrayBuffer(0))}}class S{_expirePeriodInMs=18e4;expireTimestamp;key;constructor(e,t){this.key=e?.key,this._expirePeriodInMs=t||this._expirePeriodInMs,this.expireTimestamp=Date.now()+this.expirePeriodInMs}set expirePeriodInMs(e){this._expirePeriodInMs=e}get expirePeriodInMs(){return this._expirePeriodInMs}get isExpired(){return this.expireTimestamp<=Date.now()}expire(){this.expireTimestamp=Date.now()}}class C extends S{callbackFn;constructor(e,t){super(e,t),this.callbackFn=e?.callbackFn}}class k extends S{error;data;constructor(e,t){super(e,t),this.error=e?.error,this.data=e?.data}}class ${queues={sent:{},received:{}};_expirePeriodInMs;matchSentQueueWithReceiveQueue(){Object.keys(this.queues.sent).forEach((e=>{const t=this.queues.sent[e],s=this.queues.received[e];t?.callbackFn&&s&&(t.callbackFn(s.error,s.data),t.expire()),t?.isExpired&&(this.queues.sent[e]=null,delete this.queues.sent[e],this.queues.received[e]=null,delete this.queues.received[e])}))}cleanUpReceivedQueue(){Object.keys(this.queues.received).forEach((e=>{const t=this.queues.received[e];t?.isExpired&&(this.queues.received[e]=null,delete this.queues.received[e])}))}runQueue(){return setTimeout((()=>{this.matchSentQueueWithReceiveQueue(),this.cleanUpReceivedQueue(),this.runQueue()}),0),this}constructor(){this.runQueue()}expirePeriodInMs(e){return this._expirePeriodInMs=e,this}async addToSentQueue(e,t){return new Promise(((s,n)=>{const i=e.generateKey();this.queues.sent[i]=new C({key:i,callbackFn:(e,i)=>{t&&t(e,i),e?n(e):s(i)}},this._expirePeriodInMs)}))}addToReceivedQueue(e,t,s){const n=e.generateKey();this.queues.received[n]=new k({key:n,error:t,data:s},this._expirePeriodInMs)}getSentQueue(){return Object.values(this.queues.sent).filter((e=>e))}getReceivedQueue(){return Object.values(this.queues.received).filter((e=>e))}}class T{noLagClient;connectOptions;authToken;topics={};heartbeatTimer;defaultCheckConnectionInterval=1e4;checkConnectionInterval;heartBeatInterval=2e4;visibilityState=l.Visible;callbackOnReceive;callbackOnDisconnect=()=>{};callbackOnReconnect=()=>{};callbackOnReceivedError=()=>{};acknowledgeQueueManager=new $;connectionOptions;constructor(e,t,s,n){this.connectionOptions=s,this.checkConnectionInterval=n?.checkConnectionInterval??this.defaultCheckConnectionInterval,this.connectOptions={...n,...s},this.authToken=t,this.noLagClient=new w(e,this.authToken,this.acknowledgeQueueManager,this.connectOptions),this.onClose(),this.onError(),this.onReceiveMessage(),s?.disconnectOnNoVisibility&&this.onVisibilityChange()}get deviceTokenId(){return this.noLagClient?.deviceTokenId}startHeartbeat(){this.heartbeatTimer=setInterval((()=>{this.noLagClient.heartbeat()}),this.heartBeatInterval)}stopHeartbeat(){clearInterval(this.heartbeatTimer)}async initiate(e,t){return this.noLagClient.setReConnect(e),await this.noLagClient.connect(t),this.noLagClient.setReConnect(!1),this.startHeartbeat(),this}connect(e){return this.initiate(!1,e)}onVisibilityChange(){document.addEventListener&&document.addEventListener("visibilitychange",(async()=>{switch(this.visibilityState=document.visibilityState,this.visibilityState){case l.Hidden:this.noLagClient?.disconnect(),this.stopHeartbeat();break;case l.Visible:await this.initiate(!0)}}))}onReceiveMessage(){const e=this;this.noLagClient?.onReceiveMessage(((t,s)=>{const{topicName:n,identifiers:i}=s;this.noLagClient&&!this.topics[n]&&(this.topics[n]=new v(e,this.noLagClient,n,{OR:i},this.acknowledgeQueueManager)),n&&this.topics[n]&&this.topics[n]?._onReceiveMessage(s),"function"==typeof this.callbackOnReceive&&this.callbackOnReceive(s)}))}reconnect(){this.stopHeartbeat(),setTimeout((async()=>{await this.initiate(!0),"function"==typeof this.callbackOnReconnect&&this.callbackOnReconnect()}),this.checkConnectionInterval)}canReconnect(){return this.visibilityState!==l.Hidden}doReconnect(){this.canReconnect()?this.reconnect():(this.stopHeartbeat(),"function"==typeof this.callbackOnDisconnect&&this.callbackOnDisconnect("connection retry timeout."))}onClose(){this.noLagClient.onClose(((e,t)=>{this.doReconnect(),"function"==typeof this.callbackOnReceivedError&&this.callbackOnReceivedError(e)}))}onError(){this.noLagClient.onError(((e,t)=>{"function"==typeof this.callbackOnReceivedError&&this.callbackOnReceivedError(e)}))}onReceive(e){this.callbackOnReceive=e}disconnect(){this.visibilityState=l.Hidden,this.noLagClient?.disconnect()}onDisconnect(e){this.callbackOnDisconnect=e}onReconnect(e){this.callbackOnReconnect=e}onErrors(e){this.callbackOnReceivedError=e}getTopic(e,t){if(!this.topics[e]){const s=new v(this,this.noLagClient,e,{},this.acknowledgeQueueManager);s.subscribe(((e,s)=>{t&&t(e,s)})),this.topics[e]=s}return this.topics[e]}unsubscribe(e,t){return!!this.topics[e]&&(this.topics[e]?.unsubscribe(t),!0)}subscribe(e,t={},s){if(!this.noLagClient)throw new Error("NoLag client is not set. Please connect to NoLag before attempting to subscribe.");if(this.topics[e]){const s=this.topics[e];return t?.OR?.length&&0!==t?.OR?.length&&s.addIdentifiers(t),s}return(this.topics[e]=new v(this,this.noLagClient,e,t,this.acknowledgeQueueManager)).subscribe(s),this.topics[e]}publish(t,s,n=[]){if(this.noLagClient&&this.noLagClient.send){this.stopHeartbeat();const i=o().setCommand(e.Topic,t);n?.length>0&&i.setCommand(e.Identifier,n);const a=c.encode(i,s);this.noLagClient.send(b.TunnelPublish,a),this.startHeartbeat()}}get status(){return this.noLagClient?.connectionStatus??null}}const R=e=>{const t=new WebSocket(e);t.binaryType=d.Arraybuffer;const s={send:e=>{t.send(e)},close:()=>{t.close()}};return t.onopen=e=>{s?.onOpen&&s.onOpen(e)},t.onclose=e=>{s?.onClose&&s.onClose(e)},t.onerror=e=>{s?.onError&&s.onError(e)},t.onmessage=e=>{s?.onMessage&&s.onMessage(e.data)},s};class O{routeNamespace="devices";parentRouteNamespace;tunnelId;requestParams;constructor(e,t,s){this.parentRouteNamespace=e,this.tunnelId=t,this.requestParams=s}async createDevice(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}`,{method:"POST",headers:this.requestParams.headers,body:JSON.stringify(e)});if(t.status>=400)throw await t.json();return t.json()}async getDeviceById(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"GET",headers:this.requestParams.headers});if(t.status>=400)throw await t.json();return t.json()}async listDevices(e){const t=I(e),s=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}${t}`,{method:"GET",headers:this.requestParams.headers});if(s.status>=400)throw await s.json();return s.json()}async updateDevice(e,t){const s=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"PATCH",headers:this.requestParams.headers,body:JSON.stringify(t)});if(s.status>=400)throw await s.json();return s.json()}async deleteDevice(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"DELETE",headers:this.requestParams.headers});if(t.status>=400)throw await t.json();return t.json()}}const A=async(t,s,n,i,a,r,h)=>{const u=o().setCommand(e.Topic,s).setCommand(e.Identifier,n).setCommand(e.AddAction),d=c.encode(u,t),l=`${h?.protocol}://${h?.wsHost}`;return await fetch(`${l}/${a}/${i}/publish`,{headers:r.headers,method:"POST",body:d}),!0};class M{routeNamespace="topics";parentRouteNamespace;tunnelId;requestParams;constructor(e,t,s){this.parentRouteNamespace=e,this.tunnelId=t,this.requestParams=s}async createTopic(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}`,{method:"POST",headers:this.requestParams.headers,body:JSON.stringify(e)});if(t.status>=400)throw await t.json();return t.json()}async getTopicById(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"GET",headers:this.requestParams.headers});if(t.status>=400)throw await t.json();return t.json()}async listTopics(e){const t=e?I(e):"",s=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}${t}`,{method:"GET",headers:this.requestParams.headers});if(s.status>=400)throw await s.json();return s.json()}async updateTopic(e,t){const s=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"PATCH",headers:this.requestParams.headers,body:JSON.stringify(t)});if(s.status>=400)throw await s.json();return s.json()}async deleteTopic(e){const t=await fetch(`${this.requestParams.baseURL}/${this.parentRouteNamespace}/${this.tunnelId}/${this.routeNamespace}/${e}`,{method:"DELETE",headers:this.requestParams.headers});if(t.status>=400)throw await t.json();return t.json()}}class N{routeNamespace="tunnels";tunnelId;requestParams;apiTunnel;constructor(e,t,s){this.tunnelId=t,this.requestParams=s,this.apiTunnel=e}get topics(){return new M(this.routeNamespace,this.tunnelId,this.requestParams)}get devices(){return new O(this.routeNamespace,this.tunnelId,this.requestParams)}async getTunnel(){const e=await fetch(`${this.requestParams.baseURL}/${this.routeNamespace}/${this.tunnelId}`,{method:"GET",headers:this.requestParams.headers});if(e.status>=400)throw await e.json();return e.json()}async updateTunnel(e){const t=await fetch(`${this.requestParams.baseURL}/${this.routeNamespace}/${this.tunnelId}`,{method:"PATCH",headers:this.requestParams.headers,body:JSON.stringify(e)});if(t.status>=400)throw await t.json();return t.json()}async deleteTunnel(){const e=await fetch(`${this.requestParams.baseURL}/${this.routeNamespace}/${this.tunnelId}`,{method:"DELETE",headers:this.requestParams.headers});if(e.status>=400)throw await e.json();return e.json()}async publish(e){const{data:t,topicName:s,identifiers:n}=e;return A(t,s,n,this.tunnelId,this.routeNamespace,this.requestParams,this.apiTunnel.connectOptions)}}class P{apiKey;connectOptions;requestParams;constructor(e,t){this.connectOptions={host:y.DefaultApiHost,protocol:y.DefaultHttpProtocol,url:y.DefaultApiUrl,wsUrl:y.DefaultWsUrl,wsHost:y.DefaultWsHost,apiKey:e,...t},this.apiKey=e,this.requestParams={baseURL:`${this.connectOptions?.protocol}://${this.connectOptions?.host}${this.connectOptions?.url}`,headers:{"X-API-Key":this.apiKey,"Content-Type":"application/json"}}}async tunnels(e){const t=new URLSearchParams(e).toString();return(await fetch(`${this.requestParams.baseURL}/tunnels${t?`?${t}`:""}`,{headers:this.requestParams.headers,method:"get"})).json()}async createTunnel(e){const t=await fetch(`${this.requestParams.baseURL}/tunnels`,{method:"POST",headers:this.requestParams.headers,body:JSON.stringify(e)});if(t.status>=400)throw await t.json();return t.json()}tunnel(e){return new N(this,e,this.requestParams)}}const _=(e,t)=>new P(e,t);class D{fileName;token;url;contentType;size;constructor(e){this.fileName=e.fileName,this.token=e.token,this.url=e.url,this.contentType=e.contentType,this.size=e.size}}function j(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var E,q={exports:{}};var U=j((E||(E=1,q.exports=function(){var e=1e3,t=6e4,s=36e5,n="millisecond",i="second",a="minute",r="hour",o="day",c="week",h="month",u="quarter",d="year",l="date",p="Invalid Date",f=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,m=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,g={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(e){var t=["th","st","nd","rd"],s=e%100;return"["+e+(t[(s-20)%10]||t[s]||t[0])+"]"}},b=function(e,t,s){var n=String(e);return!n||n.length>=t?e:""+Array(t+1-n.length).join(s)+e},v={s:b,z:function(e){var t=-e.utcOffset(),s=Math.abs(t),n=Math.floor(s/60),i=s%60;return(t<=0?"+":"-")+b(n,2,"0")+":"+b(i,2,"0")},m:function e(t,s){if(t.date()<s.date())return-e(s,t);var n=12*(s.year()-t.year())+(s.month()-t.month()),i=t.clone().add(n,h),a=s-i<0,r=t.clone().add(n+(a?-1:1),h);return+(-(n+(s-i)/(a?i-r:r-i))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(e){return{M:h,y:d,w:c,d:o,D:l,h:r,m:a,s:i,ms:n,Q:u}[e]||String(e||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},I="en",y={};y[I]=g;var w="$isDayjsObject",S=function(e){return e instanceof T||!(!e||!e[w])},C=function e(t,s,n){var i;if(!t)return I;if("string"==typeof t){var a=t.toLowerCase();y[a]&&(i=a),s&&(y[a]=s,i=a);var r=t.split("-");if(!i&&r.length>1)return e(r[0])}else{var o=t.name;y[o]=t,i=o}return!n&&i&&(I=i),i||!n&&I},k=function(e,t){if(S(e))return e.clone();var s="object"==typeof t?t:{};return s.date=e,s.args=arguments,new T(s)},$=v;$.l=C,$.i=S,$.w=function(e,t){return k(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})};var T=function(){function g(e){this.$L=C(e.locale,null,!0),this.parse(e),this.$x=this.$x||e.x||{},this[w]=!0}var b=g.prototype;return b.parse=function(e){this.$d=function(e){var t=e.date,s=e.utc;if(null===t)return new Date(NaN);if($.u(t))return new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var n=t.match(f);if(n){var i=n[2]-1||0,a=(n[7]||"0").substring(0,3);return s?new Date(Date.UTC(n[1],i,n[3]||1,n[4]||0,n[5]||0,n[6]||0,a)):new Date(n[1],i,n[3]||1,n[4]||0,n[5]||0,n[6]||0,a)}}return new Date(t)}(e),this.init()},b.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},b.$utils=function(){return $},b.isValid=function(){return!(this.$d.toString()===p)},b.isSame=function(e,t){var s=k(e);return this.startOf(t)<=s&&s<=this.endOf(t)},b.isAfter=function(e,t){return k(e)<this.startOf(t)},b.isBefore=function(e,t){return this.endOf(t)<k(e)},b.$g=function(e,t,s){return $.u(e)?this[t]:this.set(s,e)},b.unix=function(){return Math.floor(this.valueOf()/1e3)},b.valueOf=function(){return this.$d.getTime()},b.startOf=function(e,t){var s=this,n=!!$.u(t)||t,u=$.p(e),p=function(e,t){var i=$.w(s.$u?Date.UTC(s.$y,t,e):new Date(s.$y,t,e),s);return n?i:i.endOf(o)},f=function(e,t){return $.w(s.toDate()[e].apply(s.toDate("s"),(n?[0,0,0,0]:[23,59,59,999]).slice(t)),s)},m=this.$W,g=this.$M,b=this.$D,v="set"+(this.$u?"UTC":"");switch(u){case d:return n?p(1,0):p(31,11);case h:return n?p(1,g):p(0,g+1);case c:var I=this.$locale().weekStart||0,y=(m<I?m+7:m)-I;return p(n?b-y:b+(6-y),g);case o:case l:return f(v+"Hours",0);case r:return f(v+"Minutes",1);case a:return f(v+"Seconds",2);case i:return f(v+"Milliseconds",3);default:return this.clone()}},b.endOf=function(e){return this.startOf(e,!1)},b.$set=function(e,t){var s,c=$.p(e),u="set"+(this.$u?"UTC":""),p=(s={},s[o]=u+"Date",s[l]=u+"Date",s[h]=u+"Month",s[d]=u+"FullYear",s[r]=u+"Hours",s[a]=u+"Minutes",s[i]=u+"Seconds",s[n]=u+"Milliseconds",s)[c],f=c===o?this.$D+(t-this.$W):t;if(c===h||c===d){var m=this.clone().set(l,1);m.$d[p](f),m.init(),this.$d=m.set(l,Math.min(this.$D,m.daysInMonth())).$d}else p&&this.$d[p](f);return this.init(),this},b.set=function(e,t){return this.clone().$set(e,t)},b.get=function(e){return this[$.p(e)]()},b.add=function(n,u){var l,p=this;n=Number(n);var f=$.p(u),m=function(e){var t=k(p);return $.w(t.date(t.date()+Math.round(e*n)),p)};if(f===h)return this.set(h,this.$M+n);if(f===d)return this.set(d,this.$y+n);if(f===o)return m(1);if(f===c)return m(7);var g=(l={},l[a]=t,l[r]=s,l[i]=e,l)[f]||1,b=this.$d.getTime()+n*g;return $.w(b,this)},b.subtract=function(e,t){return this.add(-1*e,t)},b.format=function(e){var t=this,s=this.$locale();if(!this.isValid())return s.invalidDate||p;var n=e||"YYYY-MM-DDTHH:mm:ssZ",i=$.z(this),a=this.$H,r=this.$m,o=this.$M,c=s.weekdays,h=s.months,u=s.meridiem,d=function(e,s,i,a){return e&&(e[s]||e(t,n))||i[s].slice(0,a)},l=function(e){return $.s(a%12||12,e,"0")},f=u||function(e,t,s){var n=e<12?"AM":"PM";return s?n.toLowerCase():n};return n.replace(m,(function(e,n){return n||function(e){switch(e){case"YY":return String(t.$y).slice(-2);case"YYYY":return $.s(t.$y,4,"0");case"M":return o+1;case"MM":return $.s(o+1,2,"0");case"MMM":return d(s.monthsShort,o,h,3);case"MMMM":return d(h,o);case"D":return t.$D;case"DD":return $.s(t.$D,2,"0");case"d":return String(t.$W);case"dd":return d(s.weekdaysMin,t.$W,c,2);case"ddd":return d(s.weekdaysShort,t.$W,c,3);case"dddd":return c[t.$W];case"H":return String(a);case"HH":return $.s(a,2,"0");case"h":return l(1);case"hh":return l(2);case"a":return f(a,r,!0);case"A":return f(a,r,!1);case"m":return String(r);case"mm":return $.s(r,2,"0");case"s":return String(t.$s);case"ss":return $.s(t.$s,2,"0");case"SSS":return $.s(t.$ms,3,"0");case"Z":return i}return null}(e)||i.replace(":","")}))},b.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},b.diff=function(n,l,p){var f,m=this,g=$.p(l),b=k(n),v=(b.utcOffset()-this.utcOffset())*t,I=this-b,y=function(){return $.m(m,b)};switch(g){case d:f=y()/12;break;case h:f=y();break;case u:f=y()/3;break;case c:f=(I-v)/6048e5;break;case o:f=(I-v)/864e5;break;case r:f=I/s;break;case a:f=I/t;break;case i:f=I/e;break;default:f=I}return p?f:$.a(f)},b.daysInMonth=function(){return this.endOf(h).$D},b.$locale=function(){return y[this.$L]},b.locale=function(e,t){if(!e)return this.$L;var s=this.clone(),n=C(e,t,!0);return n&&(s.$L=n),s},b.clone=function(){return $.w(this.$d,this)},b.toDate=function(){return new Date(this.valueOf())},b.toJSON=function(){return this.isValid()?this.toISOString():null},b.toISOString=function(){return this.$d.toISOString()},b.toString=function(){return this.$d.toUTCString()},g}(),R=T.prototype;return k.prototype=R,[["$ms",n],["$s",i],["$m",a],["$H",r],["$W",o],["$M",h],["$y",d],["$D",l]].forEach((function(e){R[e[1]]=function(t){return this.$g(t,e[0],e[1])}})),k.extend=function(e,t){return e.$i||(e(t,T,k),e.$i=!0),k},k.locale=C,k.isDayjs=S,k.unix=function(e){return k(1e3*e)},k.en=y[I],k.Ls=y,k.p={},k}()),q.exports));class L{messageId;readDate;userId;constructor(e){this.messageId=e.messageId,this.readDate=e.readDate?e.readDate:U().toISOString(),this.userId=e.userId}}class x{messageId;emoji;userId;constructor(e){this.messageId=e.messageId,this.emoji=e.emoji,this.userId=e.userId}}const H=[];for(let e=0;e<256;++e)H.push((e+256).toString(16).slice(1));let Q;const W=new Uint8Array(16);var K={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function z(e,t,s){if(K.randomUUID&&!e)return K.randomUUID();const n=(e=e||{}).random??e.rng?.()??function(){if(!Q){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Q=crypto.getRandomValues.bind(crypto)}return Q(W)}();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=15&n[6]|64,n[8]=63&n[8]|128,function(e,t=0){return(H[e[t+0]]+H[e[t+1]]+H[e[t+2]]+H[e[t+3]]+"-"+H[e[t+4]]+H[e[t+5]]+"-"+H[e[t+6]]+H[e[t+7]]+"-"+H[e[t+8]]+H[e[t+9]]+"-"+H[e[t+10]]+H[e[t+11]]+H[e[t+12]]+H[e[t+13]]+H[e[t+14]]+H[e[t+15]]).toLowerCase()}(n)}class Y{messageId;sentDate;messageText;files=[];mentionMessageId;originalMessageId;userId;readReceipts=[];reactions=[];constructor(e){this.messageId=e.messageId??z(),this.sentDate=e.sentDate??U().toISOString(),this.messageText=e.messageText,this.files=Array.isArray(e.files)?e.files.map((e=>new D(e))):[],this.mentionMessageId=e.mentionMessageId,this.originalMessageId=e.originalMessageId??this.messageId,this.userId=e.userId,this.readReceipts=Array.isArray(e.readReceipts)?e.readReceipts.map((e=>new L(e))):[],this.reactions=Array.isArray(e.reactions)?e.reactions.map((e=>new x(e))):[]}setReadReceipt(e){this.readReceipts.push(e)}setReaction(e){this.reactions.push(e)}serialize(){return{messageId:this.messageId,sentDate:this.sentDate,messageText:this.messageText,files:this.files,mentionMessageId:this.mentionMessageId,originalMessageId:this.originalMessageId,userId:this.userId}}}const B=(e,t)=>{if(t&&t.includes(e))return t.replace(e,"")},J=(e,t)=>`${e}${t}`;class F{type;userId;message;readReceipt;reaction;constructor(e){this.type=e.type,this.userId=e.userId,this.message=e.message,this.readReceipt=e.readReceipt,this.reaction=e.reaction}serialize(){return{type:this.type,userId:this.userId,message:this.message,readReceipt:this.readReceipt,reaction:this.reaction}}}var G;!function(e){e.NewMessage="message:new",e.ReadReceipt="message:readReceipt",e.Reaction="message:reaction",e.KeyStroke="room:keyStroke"}(G||(G={}));const V="notification:chat:",Z="notification:space:",X="message:space:";class ee{spaceId;tunnelId;projectId;type;privateSpace;name;description;avatar;messageNotificationCount=0;chatTopic;_messages=[];_notificationCallback=[];_onMessages;constructor(e){this.spaceId=e.spaceId,this.tunnelId=e.tunnelId,this.projectId=e.projectId,this.name=e.name,this.description=e.description,this.type=e.type,this.privateSpace=e.privateSpace,this.avatar=e.avatar?new D(e.avatar):void 0}setChatTopic(e){this.chatTopic=e}get userId(){return this.chatTopic?.tunnel().deviceTokenId}setReadReceipt(e){const t=this._messages.find((t=>t.messageId===e.messageId));t&&t.setReadReceipt(e)}setReaction(e){const t=this._messages.find((t=>t.messageId===e.messageId));t&&t.setReaction(e)}addMessage(e){this._messages.push(e),this._onMessages&&this._onMessages(this._messages)}actionNotificationCallback(e){this._notificationCallback.forEach((t=>{console.log(e),console.log(t),t(e)}))}notificationHandler(e){const t=new F(JSON.parse(i(e)));switch(t.type){case G.NewMessage:this.messageNotificationCount=this.messageNotificationCount++;break;case G.KeyStroke:break;case G.Reaction:if(!t.reaction)return;this.setReaction(t.reaction);break;case G.ReadReceipt:if(!t.readReceipt)return;this.setReadReceipt(t.readReceipt)}this.actionNotificationCallback(t)}messageHandler(e){const t=new Y(JSON.parse(i(e)));this.addMessage(t)}sendMessage(e){if(!this.chatTopic||!this.userId)return;const t=new Y({userId:this.userId,...e});this.chatTopic.publish(t.serialize(),[J(X,this.spaceId??"")]),this._messages.push(t),this._onMessages&&this._onMessages(this._messages);const s=new F({type:G.NewMessage,userId:this.userId});this.chatTopic.publish(s.serialize(),[J(Z,this.spaceId??"")])}sendKeyStroke(){if(!this.chatTopic||!this.userId)return;const e=new F({type:G.KeyStroke,userId:this.userId});this.chatTopic.publish(e.serialize(),[J(Z,this.spaceId??"")])}onNotificationCallback(e){e&&this._notificationCallback.push(e)}removeNotificationCallback(){this._notificationCallback=[]}onMessagesCallback(e){e&&(this._onMessages=e)}removeMessagesCallback(){this._onMessages=void 0}transportHandler({identifiers:e,data:t,presences:s}){const n=!!B(Z,e[0]),i=!!B(X,e[0]);n&&this.notificationHandler(t),i&&this.messageHandler(t)}clearMessageReceivedCount(){this.messageNotificationCount=0}get spaceMessages(){return this._messages}serialize(){return{spaceId:this.spaceId,tunnelId:this.tunnelId,projectId:this.projectId,name:this.name,description:this.description,type:this.type,privateSpace:this.privateSpace,avatar:this.avatar}}}class te{messageText;files=[];replyMessageId;constructor(e){this.messageText=e.messageText,this.files=Array.isArray(e.files)?e.files.map((e=>new D(e))):[],this.replyMessageId=e.mentionMessageId}serialize(){return{messageText:this.messageText,files:this.files,mentionMessageId:this.replyMessageId}}}var se;!function(e){e.DM="dm",e.GROUP="group"}(se||(se={}));const ne=[new ee({name:"A space to chill",description:"Where the cool kids come to have fun!",spaceId:"1",tunnelId:"29a3d020-0f31-498b-9e41-ee90f14d84b7",projectId:"849ea6bf-1f49-46e6-a7b5-9365abe17a87",type:se.GROUP,privateSpace:!0}),new ee({name:"Space the final frontier",description:"Talk about all things space!",spaceId:"2",tunnelId:"29a3d020-0f31-498b-9e41-ee90f14d84b7",projectId:"849ea6bf-1f49-46e6-a7b5-9365abe17a87",type:se.GROUP,privateSpace:!0})];class ie{chatAppName;tunnel;chatTopic;notificationIdentifier;userSpaces=[];_joinedSpaces={};activeSpaceId;_activeSpace;_onSpaceMessagesEvent;_onSpaceNotificationEvent;constructor(e,t){this.chatAppName=e,this.tunnel=t,this.chatTopic=this.tunnel.subscribe(e),this.setChatAppNotificationIdentifier(),this.onReceive()}onReceive(){this.chatTopic.onReceive((e=>{const{identifiers:t}=e,s=this.spaceIdFromIdentifier(t);s&&this._joinedSpaces[s]&&this._joinedSpaces[s].transportHandler(e)}))}spaceIdFromIdentifier(e){if(e?.[0])return B(Z,e[0])??B(X,e[0])}generateSpaceIdentifiers(e){return[...e.map((e=>J(X,e))),...e.map((e=>J(Z,e)))]}setChatAppNotificationIdentifier(){this.notificationIdentifier=J(V,this.chatAppName),this.chatTopic.addIdentifiers({OR:[this.notificationIdentifier]})}get joinedSpaces(){return Object.values(this._joinedSpaces).filter((e=>e))}retrieveSpaceById(e){return new Promise(((t,s)=>{const n=ne.find((t=>t.spaceId===e));n&&t(n)}))}retrieveSpaces(){return new Promise(((e,t)=>{e(ne)}))}joinSpace(e){return this._joinedSpaces[e.spaceId]=new ee(e.serialize()),this._joinedSpaces[e.spaceId]?.setChatTopic(this.chatTopic),this.chatTopic.addIdentifiers({OR:this.generateSpaceIdentifiers([e.spaceId])}),this._joinedSpaces[e.spaceId]}joinSpaces(e){return e.forEach((e=>this.joinSpace(e))),this}leaveSpace(e){return this._joinedSpaces[e]?(this._joinedSpaces[e]=null,delete this._joinedSpaces[e],this.chatTopic.removeIdentifiers(this.generateSpaceIdentifiers([e])),this):(console.error(`User never joined space ${e}.`),this)}leaveSpaces(e){return e.forEach((e=>this.leaveSpace(e))),this}setActiveSpace(e){return this._activeSpace&&(this._activeSpace.removeMessagesCallback(),this._activeSpace.removeNotificationCallback()),this.activeSpaceId=e,this._joinedSpaces[e]&&(this._activeSpace=this._joinedSpaces[e]),this._activeSpace?.onMessagesCallback(this._onSpaceMessagesEvent),this._activeSpace?.onNotificationCallback(this._onSpaceNotificationEvent),this._activeSpace}get activeSpace(){return this._activeSpace}sendMessage(e){this._activeSpace?.sendMessage(e)}sendKeyStroke(){this._activeSpace?.sendKeyStroke()}onSpaceMessagesEvent(e){e&&(this._onSpaceMessagesEvent=e)}removeSpaceMessagesEvent(){this._activeSpace?.removeMessagesCallback(),this._onSpaceMessagesEvent=void 0}onSpaceNotificationEvent(e){this._activeSpace?.onNotificationCallback(e),e&&(this._onSpaceNotificationEvent=e)}removeNotificationEvent(){this._activeSpace?.removeNotificationCallback(),this._onSpaceNotificationEvent=void 0}}const ae=(e,t,s)=>new T(R,e,t,s),re=(e,t,s)=>ae(e,t,s);export{_ as Api,P as ApiTunnel,y as CONSTANT,ie as ChatApp,F as ChatNotification,ae as Client,p as EAccessPermission,u as EConnectionStatus,d as EEncoding,g as ELoadBalanceType,b as ESendAction,f as EStatus,m as ETopicType,l as EVisibilityState,D as FileDetails,Y as Message,te as MessageSend,c as NqlTransport,x as Reaction,L as ReadReceipt,ee as Space,v as Topic,T as Tunnel,N as TunnelApi,O as TunnelDevice,A as TunnelPublish,M as TunnelTopic,re as WebSocketClient,i as bufferToString,V as chatTag,I as generateQueryString,X as messageTag,Z as notificationTag,s as stringToArrayBuffer,n as stringToBuffer,a as uint8ArrayToString};
//# sourceMappingURL=browserInstance.js.map
